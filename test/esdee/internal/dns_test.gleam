import esdee/internal/dns.{ARecord, AaaaRecord, PtrRecord, SrvRecord, TxtRecord}

// This is a know good query, to protect against changes in the internal inet_dns module.
const query_bits = <<
  0,
  0,
  0,
  0,
  0,
  1,
  0,
  0,
  0,
  0,
  0,
  0,
  11,
  95,
  103,
  111,
  111,
  103,
  108,
  101,
  99,
  97,
  115,
  116,
  4,
  95,
  116,
  99,
  112,
  5,
  108,
  111,
  99,
  97,
  108,
  0,
  0,
  255,
  0,
  1,
>>

pub fn encode_question_test() {
  assert dns.encode_question("_googlecast._tcp.local") == query_bits
}

pub fn decode_records_fail_test() {
  assert dns.decode_records(<<"Not valid":utf8>>) == Error(Nil)
}

pub fn decode_records_skip_question_test() {
  assert dns.decode_records(query_bits) == Ok([])
}

pub fn decode_records_test() {
  // This is a known good response record, with the expected values
  let data = <<
    0,
    0,
    132,
    0,
    0,
    0,
    0,
    1,
    0,
    0,
    0,
    3,
    11,
    95,
    103,
    111,
    111,
    103,
    108,
    101,
    99,
    97,
    115,
    116,
    4,
    95,
    116,
    99,
    112,
    5,
    108,
    111,
    99,
    97,
    108,
    0,
    0,
    12,
    0,
    1,
    0,
    0,
    0,
    120,
    0,
    53,
    50,
    83,
    72,
    73,
    69,
    76,
    68,
    45,
    65,
    110,
    100,
    114,
    111,
    105,
    100,
    45,
    84,
    86,
    45,
    57,
    54,
    57,
    51,
    100,
    53,
    56,
    101,
    51,
    53,
    51,
    55,
    100,
    100,
    100,
    98,
    49,
    49,
    56,
    98,
    55,
    98,
    55,
    100,
    49,
    55,
    102,
    57,
    99,
    49,
    99,
    50,
    192,
    12,
    192,
    46,
    0,
    16,
    128,
    1,
    0,
    0,
    17,
    148,
    0,
    199,
    35,
    105,
    100,
    61,
    57,
    54,
    57,
    51,
    100,
    53,
    56,
    101,
    51,
    53,
    51,
    55,
    100,
    100,
    100,
    98,
    49,
    49,
    56,
    98,
    55,
    98,
    55,
    100,
    49,
    55,
    102,
    57,
    99,
    49,
    99,
    50,
    35,
    99,
    100,
    61,
    52,
    53,
    67,
    69,
    51,
    67,
    65,
    52,
    50,
    65,
    70,
    53,
    70,
    54,
    48,
    53,
    50,
    57,
    69,
    66,
    54,
    49,
    55,
    51,
    53,
    70,
    70,
    70,
    53,
    48,
    55,
    54,
    19,
    114,
    109,
    61,
    52,
    48,
    53,
    52,
    51,
    51,
    56,
    53,
    67,
    57,
    66,
    65,
    50,
    49,
    49,
    52,
    5,
    118,
    101,
    61,
    48,
    53,
    20,
    109,
    100,
    61,
    83,
    72,
    73,
    69,
    76,
    68,
    32,
    65,
    110,
    100,
    114,
    111,
    105,
    100,
    32,
    84,
    86,
    18,
    105,
    99,
    61,
    47,
    115,
    101,
    116,
    117,
    112,
    47,
    105,
    99,
    111,
    110,
    46,
    112,
    110,
    103,
    10,
    102,
    110,
    61,
    83,
    72,
    73,
    69,
    76,
    68,
    68,
    9,
    99,
    97,
    61,
    52,
    54,
    51,
    51,
    54,
    53,
    4,
    115,
    116,
    61,
    48,
    15,
    98,
    115,
    61,
    70,
    65,
    56,
    70,
    55,
    70,
    56,
    52,
    56,
    55,
    70,
    51,
    4,
    110,
    102,
    61,
    49,
    9,
    99,
    116,
    61,
    50,
    65,
    68,
    57,
    67,
    52,
    3,
    114,
    115,
    61,
    192,
    46,
    0,
    33,
    128,
    1,
    0,
    0,
    0,
    120,
    0,
    45,
    0,
    0,
    0,
    0,
    31,
    73,
    36,
    57,
    54,
    57,
    51,
    100,
    53,
    56,
    101,
    45,
    51,
    53,
    51,
    55,
    45,
    100,
    100,
    100,
    98,
    45,
    49,
    49,
    56,
    98,
    45,
    55,
    98,
    55,
    100,
    49,
    55,
    102,
    57,
    99,
    49,
    99,
    50,
    192,
    29,
    193,
    72,
    0,
    1,
    128,
    1,
    0,
    0,
    0,
    120,
    0,
    4,
    10,
    10,
    2,
    101,
  >>

  let assert Ok(records) = dns.decode_records(data)
  assert records
    == [
      PtrRecord(
        "_googlecast._tcp.local",
        "SHIELD-Android-TV-9693d58e3537dddb118b7b7d17f9c1c2._googlecast._tcp.local",
      ),
      TxtRecord(
        "SHIELD-Android-TV-9693d58e3537dddb118b7b7d17f9c1c2._googlecast._tcp.local",
        [
          "id=9693d58e3537dddb118b7b7d17f9c1c2",
          "cd=45CE3CA42AF5F60529EB61735FFF5076",
          "rm=40543385C9BA2114",
          "ve=05",
          "md=SHIELD Android TV",
          "ic=/setup/icon.png",
          "fn=SHIELDD",
          "ca=463365",
          "st=0",
          "bs=FA8F7F8487F3",
          "nf=1",
          "ct=2AD9C4",
          "rs=",
        ],
      ),
      SrvRecord(
        "SHIELD-Android-TV-9693d58e3537dddb118b7b7d17f9c1c2._googlecast._tcp.local",
        0,
        0,
        8009,
        "9693d58e-3537-dddb-118b-7b7d17f9c1c2.local",
      ),
      ARecord("9693d58e-3537-dddb-118b-7b7d17f9c1c2.local", #(10, 10, 2, 101)),
    ]
}

pub fn decode_records_aaa_test() {
  let aaaa_response = <<
    0,
    0,
    132,
    0,
    0,
    0,
    0,
    1,
    0,
    0,
    0,
    3,
    11,
    95,
    103,
    111,
    111,
    103,
    108,
    101,
    122,
    111,
    110,
    101,
    4,
    95,
    116,
    99,
    112,
    5,
    108,
    111,
    99,
    97,
    108,
    0,
    0,
    12,
    0,
    1,
    0,
    0,
    0,
    120,
    0,
    39,
    36,
    57,
    54,
    57,
    51,
    100,
    53,
    56,
    101,
    45,
    51,
    53,
    51,
    55,
    45,
    100,
    100,
    100,
    98,
    45,
    49,
    49,
    56,
    98,
    45,
    55,
    98,
    55,
    100,
    49,
    55,
    102,
    57,
    99,
    49,
    99,
    50,
    192,
    12,
    192,
    46,
    0,
    16,
    128,
    1,
    0,
    0,
    17,
    148,
    0,
    40,
    35,
    105,
    100,
    61,
    52,
    53,
    67,
    69,
    51,
    67,
    65,
    52,
    50,
    65,
    70,
    53,
    70,
    54,
    48,
    53,
    50,
    57,
    69,
    66,
    54,
    49,
    55,
    51,
    53,
    70,
    70,
    70,
    53,
    48,
    55,
    54,
    3,
    67,
    71,
    83,
    192,
    46,
    0,
    33,
    128,
    1,
    0,
    0,
    0,
    120,
    0,
    45,
    2,
    88,
    0,
    0,
    39,
    17,
    36,
    57,
    54,
    57,
    51,
    100,
    53,
    56,
    101,
    45,
    51,
    53,
    51,
    55,
    45,
    100,
    100,
    100,
    98,
    45,
    49,
    49,
    56,
    98,
    45,
    55,
    98,
    55,
    100,
    49,
    55,
    102,
    57,
    99,
    49,
    99,
    50,
    192,
    29,
    192,
    155,
    0,
    28,
    128,
    1,
    0,
    0,
    0,
    120,
    0,
    16,
    32,
    1,
    20,
    186,
    161,
    148,
    36,
    2,
    21,
    46,
    34,
    193,
    13,
    96,
    212,
    206,
  >>
  let assert Ok(records) = dns.decode_records(aaaa_response)
  assert records
    == [
      PtrRecord(
        "_googlezone._tcp.local",
        "9693d58e-3537-dddb-118b-7b7d17f9c1c2._googlezone._tcp.local",
      ),
      TxtRecord("9693d58e-3537-dddb-118b-7b7d17f9c1c2._googlezone._tcp.local", [
        "id=45CE3CA42AF5F60529EB61735FFF5076",
        "CGS",
      ]),
      SrvRecord(
        "9693d58e-3537-dddb-118b-7b7d17f9c1c2._googlezone._tcp.local",
        600,
        0,
        10_001,
        "9693d58e-3537-dddb-118b-7b7d17f9c1c2.local",
      ),
      AaaaRecord("9693d58e-3537-dddb-118b-7b7d17f9c1c2.local", #(
        8193,
        5306,
        41_364,
        9218,
        5422,
        8897,
        3424,
        54_478,
      )),
    ]
}
